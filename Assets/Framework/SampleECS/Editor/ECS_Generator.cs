using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEditor;
using System.IO;
using System.Text;
using System.Reflection;

namespace SampleECS
{

	public static class EcsEditorTool
	{
		static string editorPath = "";
		public static string GetEditorPath 
		{
			get
			{
				if (string.IsNullOrEmpty(editorPath))
				{
					var path = Directory.GetDirectories(Application.dataPath, "*", SearchOption.AllDirectories);
					foreach (var p in path)
					{
						if (p.EndsWith("SampleECS"))
						{
							editorPath = p;
							break;
						}
					}
				}
				return editorPath;
			}
		}
	}

	public class ECS_Generator
	{
		[MenuItem("公共框架/Sample ECS/全部生成")]
		public static void BuildCodes()
		{
			string gen_path = EcsEditorTool.GetEditorPath + "/GenCodes/";
			if (!Directory.Exists(gen_path))
				Directory.CreateDirectory(gen_path);


			var asm_all_types = Assembly.GetAssembly(typeof(ECS_Context)).GetTypes();
			Gen_Context_Wrap(gen_path + "ECS_Context_Wrap.cs", asm_all_types);
			Gen_Component_Wrap(gen_path + "ECS_Component_Wrap.cs", asm_all_types);
			Gen_Entity_Wrap(gen_path + "ECS_Entity_Wrap.cs", asm_all_types);

			AssetDatabase.Refresh();
		}

		static void Gen_Context_Wrap(string file_path, System.Type[] asm_all_types)
		{
			StringBuilder _sctipt = new StringBuilder();
			_sctipt.AppendLine("/*");
			_sctipt.AppendLine("\tAuto Generated By SampleECS,Don't Modify It Manually!");
			_sctipt.AppendLine("*/");
			_sctipt.AppendLine("namespace SampleECS");
			_sctipt.AppendLine("{");
			_sctipt.AppendLine("\tpublic partial class ECS_Context");
			_sctipt.AppendLine("\t{");

			foreach (var type in asm_all_types)
			{
				System.ObsoleteAttribute obs = type.GetCustomAttribute<System.ObsoleteAttribute>();
				if (obs != null)
					continue;

				ComponentAttribute ca = type.GetCustomAttribute<ComponentAttribute>();
				
				if (ca != null)
				{
					_sctipt.AppendLine(string.Format("\t\tpublic ECS_Component_Pool<{0}> pool_{1};", type, type));
				}
			}

			_sctipt.AppendLine("\t\tpublic void InitComPool(int context_id)");
			_sctipt.AppendLine("\t\t{");
			foreach (var type in asm_all_types)
			{
				System.ObsoleteAttribute obs = type.GetCustomAttribute<System.ObsoleteAttribute>();
				if (obs != null)
					continue;

				ComponentAttribute ca = type.GetCustomAttribute<ComponentAttribute>();
				if (ca != null)
				{
					_sctipt.AppendLine("\t\t\tcomponent_pool_container_ptr++;");
					_sctipt.AppendLine(string.Format("\t\t\tpool_{0} = ECS_Component_Pool<{1}>.GetPool(context_id,typeof({2}));", type, type, type));
					_sctipt.AppendLine("\t\t\tECS_Utils.SetArrayElement(ref component_pool_container,component_pool_container_ptr," + string.Format("pool_{0}", type) + ");");
					_sctipt.AppendLine("");
				}
			}
			_sctipt.AppendLine("\t\t}");

			_sctipt.AppendLine("\t}");
			_sctipt.AppendLine("}");

			using (var e_file = File.CreateText(file_path))
			{
				e_file.Write(_sctipt.ToString());
				e_file.Flush();
			}
		}

		static void Gen_Component_Wrap(string file_path, System.Type[] asm_all_types)
		{
			StringBuilder _sctipt = new StringBuilder();
			_sctipt.AppendLine("/*");
			_sctipt.AppendLine("\tAuto Generated By SampleECS,Don't Modify It Manually!");
			_sctipt.AppendLine("*/");
			_sctipt.AppendLine("using System.Collections.Generic;");
			_sctipt.AppendLine("namespace SampleECS");
			_sctipt.AppendLine("{");

			//entity_sctipt.AppendLine("\t\t}");
			_sctipt.AppendLine("\tpublic static partial class ECS_Component_Type");
			_sctipt.AppendLine("\t{");
			int com_id = 0;
			foreach (var type in asm_all_types)
			{
				System.ObsoleteAttribute obs = type.GetCustomAttribute<System.ObsoleteAttribute>();
				if (obs != null)
					continue;

				ComponentAttribute ca = type.GetCustomAttribute<ComponentAttribute>();
				if (ca != null)
				{
					_sctipt.AppendLine(string.Format("\t\t/* Component <{0}> ID */", type));
					_sctipt.AppendLine(string.Format("\t\tpublic const int {0} = {1};", type, com_id));
					com_id++;
				}
			}
			_sctipt.AppendLine("\t}");

			_sctipt.AppendLine("");

			//entity_sctipt.AppendLine("\t\tstatic Dictionary<string,int> COM_TYPE_ID_MAP = new Dictionary<string, int>();");
			_sctipt.AppendLine("\tpublic static partial class ECS_Component_Wrap");
			_sctipt.AppendLine("\t{");
			_sctipt.AppendLine("\t\tstatic bool inited = false;");
			_sctipt.AppendLine("\t\tpublic static void Init()");
			_sctipt.AppendLine("\t\t{");
			_sctipt.AppendLine("\t\t\tif(inited) return;");
			foreach (var type in asm_all_types)
			{
				System.ObsoleteAttribute obs = type.GetCustomAttribute<System.ObsoleteAttribute>();
				if (obs != null)
					continue;

				ComponentAttribute ca = type.GetCustomAttribute<ComponentAttribute>();
				if (ca != null)
				{
					_sctipt.AppendLine(string.Format("\t\t\tCOM_TYPE_ID_MAP.Add(\"{0}\",ECS_Component_Type.{1});", type.ToString(), type));
				}
			}

			_sctipt.AppendLine("\t\t\tECS_Component_Type.SetTypeCount(COM_TYPE_ID_MAP.Count);");
			_sctipt.AppendLine("\t\t\tinited = true;");
			_sctipt.AppendLine("\t\t}");

			_sctipt.AppendLine("\t}");
			_sctipt.AppendLine("}");

			using (var e_file = File.CreateText(file_path))
			{
				e_file.Write(_sctipt.ToString());
				e_file.Flush();
			}
		}

		static void Gen_Entity_Wrap(string file_path, System.Type[] asm_all_types)
		{

			StringBuilder _sctipt = new StringBuilder();
			_sctipt.AppendLine("/*");
			_sctipt.AppendLine("\tAuto Generated By SampleECS,Don't Modify It Manually!");
			_sctipt.AppendLine("*/");
			_sctipt.AppendLine("namespace SampleECS");
			_sctipt.AppendLine("{");
			_sctipt.AppendLine("\tpublic partial class ECS_Entity");
			_sctipt.AppendLine("\t{");

			_sctipt.AppendLine("\t\tconst int INVAILD_IDX = -1;");
			_sctipt.AppendLine("");

			//反射收集全部Component类型
			foreach (var type in asm_all_types)
			{
				System.ObsoleteAttribute obs = type.GetCustomAttribute<System.ObsoleteAttribute>();
				if (obs != null)
					continue;

				ComponentAttribute ca = type.GetCustomAttribute<ComponentAttribute>();
				if (ca != null)
				{
					_sctipt.AppendLine("\t\t/************ Begin Component Code : " + type + " ************/");
					string com_field = type.ToString().ToLower();
					string pool = "context.pool_" + type;
					string pid = "poolIndecies[ECS_Component_Type." + type + "]";

					//Component引用
					_sctipt.AppendLine("\t\tpublic " + type + " " + com_field +
						"{ get { return " + pool + ".data_pool[" + pid + "-1].user_struct; } "
						+ "set {" + pool + ".data_pool[" + pid + "-1].user_struct = value; }"
						+ "}");

					//Has Component
					_sctipt.AppendLine("\t\tpublic bool has_" + type + " { get { return " + pid + "-1 != INVAILD_IDX; } }");

					//Add Component
					_sctipt.AppendLine(string.Format("\t\tpublic void Add_{0}({1} com)", type, type) +
						" {");
					_sctipt.AppendLine("\t\t\tif(" + pid + "-1 == INVAILD_IDX) {" + pid + " = " + pool + ".NewComponent(com) +1; " +
						"context.OnEntityChange(this); }");
					_sctipt.AppendLine("\t\t\tif (!entityDirty) { entityDirty = true; context.excute_ptr++; context.excuteEntities[context.excute_ptr] = _in_context_idx; }");
					_sctipt.AppendLine("\t\t\tif (context.ExcutingSystem) { com_dirtyMarkBack_Ptr++; com_dirtyMarkBack[com_dirtyMarkBack_Ptr] = ECS_Component_Type." + type + "; }");
					_sctipt.AppendLine("\t\t\telse { com_dirtyMarkFront_Ptr++; com_dirtyMarkFront[com_dirtyMarkFront_Ptr] = ECS_Component_Type." + type + "; }");
					_sctipt.AppendLine("\t\t}");

					//Remove Component
					_sctipt.AppendLine("\t\tpublic void Remove_" + type + "() {");
					_sctipt.AppendLine("\t\t\tif (!has_" + type + ") return;");
					_sctipt.AppendLine("\t\t\t" + pool + ".Recycle(" + pid + "); " + pid + " = 0; context.OnEntityChange(this);");
					_sctipt.AppendLine("\t\t}");

                    //Replace Component
                    _sctipt.AppendLine(string.Format("\t\tpublic void Replace_{0}({1} com)", type, type));
					_sctipt.AppendLine("\t\t{");
					_sctipt.AppendLine("\t\t\tif (!entityDirty) { entityDirty = true; context.excute_ptr++; context.excuteEntities[context.excute_ptr] = _in_context_idx; }");
					_sctipt.AppendLine("\t\t\t" + com_field + " = com;");
					_sctipt.AppendLine("\t\t\tif (context.ExcutingSystem) { com_dirtyMarkBack_Ptr++; com_dirtyMarkBack[com_dirtyMarkBack_Ptr] = ECS_Component_Type." + type + "; }");
					_sctipt.AppendLine("\t\t\telse { com_dirtyMarkFront_Ptr++; com_dirtyMarkFront[com_dirtyMarkFront_Ptr] = ECS_Component_Type." + type + "; }");

					_sctipt.AppendLine("\t\t}");
					_sctipt.AppendLine("\t\t/************ End Component Code : " + type + " ************/");
					_sctipt.AppendLine("");
				}
			}
			_sctipt.AppendLine("\t}");
			_sctipt.AppendLine("}");

			using (var e_file = File.CreateText(file_path))
			{
				e_file.Write(_sctipt.ToString());
				e_file.Flush();
			}
		}

		[MenuItem("公共框架/Sample ECS/全部清理")]
		public static void CleanCodes()
		{
			string gen_path = EcsEditorTool.GetEditorPath + "/GenCodes";
			if (Directory.Exists(gen_path))
				Directory.Delete(gen_path, true);

			AssetDatabase.Refresh();
		}
	}
}